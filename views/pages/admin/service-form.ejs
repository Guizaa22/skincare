<%- include('../../partials/admin-header', {title: (service ? 'Edit' : 'Add') + ' Service - SkinSense', description: 'Add or edit a skincare service.'}) %>

<%- include('../../partials/admin-nav', {currentPage: 'services'}) %>

<!-- Admin Service Form -->
<div class="admin-container with-nav">
    <div class="admin-header">
        <div class="d-flex justify-content-between align-items-center">
            <div>
                <h1><i class="fas fa-spa me-3"></i><%= service ? 'Edit' : 'Add New' %> Service</h1>
                <p class="text-muted">Fill in the details below to <%= service ? 'update' : 'create' %> a service</p>
            </div>
            <div class="admin-actions">
                <a href="/admin/services" class="btn btn-outline-secondary">
                    <i class="fas fa-arrow-left me-2"></i>Back to Services
                </a>
            </div>
        </div>
    </div>

    <!-- Service Form -->
    <div class="form-container">
        <!-- Validation Summary -->
        <div class="validation-summary" id="validationSummary">
            <h5>
                <i class="fas fa-exclamation-triangle"></i>
                Please fix the following errors:
            </h5>
            <ul id="validationErrors"></ul>
        </div>
        
        <form id="serviceForm" enctype="multipart/form-data" novalidate>
            <div class="row g-4">
                <!-- Basic Information -->
                <div class="col-12">
                    <div class="form-card">
                        <h3><i class="fas fa-info-circle me-2"></i>Basic Information</h3>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Service Name *</label>
                                <input type="text" name="name" id="serviceName" class="form-control" 
                                       value="<%= service ? service.name : '' %>" 
                                       placeholder="e.g., Deep Cleansing Facial" required
                                       minlength="3" maxlength="100">
                                <div class="invalid-feedback">
                                    Service name is required (3-100 characters)
                                </div>
                                <div class="field-hint">Enter a descriptive name for your service</div>
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label">Category *</label>
                                <select name="category" id="serviceCategory" class="form-select" required>
                                    <option value="">Select Category</option>
                                    <option value="facial-treatments" <%= service && service.category === 'facial-treatments' ? 'selected' : '' %>>Facial Treatments</option>
                                    <option value="body-treatments" <%= service && service.category === 'body-treatments' ? 'selected' : '' %>>Body Treatments</option>
                                    <option value="anti-aging" <%= service && service.category === 'anti-aging' ? 'selected' : '' %>>Anti-Aging</option>
                                    <option value="acne-treatments" <%= service && service.category === 'acne-treatments' ? 'selected' : '' %>>Acne Treatments</option>
                                    <option value="skin-analysis" <%= service && service.category === 'skin-analysis' ? 'selected' : '' %>>Skin Analysis</option>
                                    <option value="chemical-peels" <%= service && service.category === 'chemical-peels' ? 'selected' : '' %>>Chemical Peels</option>
                                    <option value="microdermabrasion" <%= service && service.category === 'microdermabrasion' ? 'selected' : '' %>>Microdermabrasion</option>
                                    <option value="laser-treatments" <%= service && service.category === 'laser-treatments' ? 'selected' : '' %>>Laser Treatments</option>
                                    <option value="consultation" <%= service && service.category === 'consultation' ? 'selected' : '' %>>Consultation</option>
                                    <option value="packages" <%= service && service.category === 'packages' ? 'selected' : '' %>>Packages</option>
                                </select>
                                <div class="invalid-feedback">
                                    Please select a category
                                </div>
                                <div class="field-hint">Choose the service category</div>
                            </div>
                            
                            <div class="col-md-3">
                                <label class="form-label">Price ($) *</label>
                                <input type="number" name="price" id="servicePrice" class="form-control" 
                                       value="<%= service ? service.price : '' %>" 
                                       min="0" step="0.01" placeholder="150.00" required>
                                <div class="invalid-feedback">
                                    Price must be greater than $0
                                </div>
                                <div class="field-hint">Enter price in USD</div>
                            </div>
                            
                            <div class="col-md-12">
                                <label class="form-label">Short Description *</label>
                                <input type="text" name="shortDescription" id="shortDescription" class="form-control" 
                                       value="<%= service ? service.shortDescription : '' %>" 
                                       placeholder="Brief description (10-200 characters)" 
                                       maxlength="200" minlength="10" required>
                                <div class="invalid-feedback">
                                    Short description is required (10-200 characters)
                                </div>
                                <div class="char-counter">
                                    <span id="shortDescCounter">0</span>/200 characters
                                </div>
                            </div>
                            
                            <div class="col-md-12">
                                <label class="form-label">Full Description *</label>
                                <textarea name="description" id="fullDescription" class="form-control" rows="4" 
                                          placeholder="Detailed description of the service (10-1000 characters)" 
                                          minlength="10" maxlength="1000" required><%= service ? service.description : '' %></textarea>
                                <div class="invalid-feedback">
                                    Full description is required (10-1000 characters)
                                </div>
                                <div class="char-counter">
                                    <span id="fullDescCounter">0</span>/1000 characters
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Service Details -->
                <div class="col-md-6">
                    <div class="form-card">
                        <h3><i class="fas fa-clock me-2"></i>Service Details</h3>
                        
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Duration (minutes) *</label>
                                <input type="number" name="duration" id="serviceDuration" class="form-control" 
                                       value="<%= service ? service.duration : '' %>" 
                                       min="15" step="15" placeholder="60" required>
                                <div class="invalid-feedback">
                                    Duration must be at least 15 minutes (in 15-minute intervals)
                                </div>
                                <div class="field-hint">Enter duration in 15-minute intervals (15, 30, 45, 60, etc.)</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Display Order</label>
                                <input type="number" name="displayOrder" id="displayOrder" class="form-control" 
                                       value="<%= service ? service.displayOrder : 0 %>" 
                                       min="0" placeholder="0">
                                <div class="field-hint">Lower numbers appear first (0 = highest priority)</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Age Restriction</label>
                                <input type="number" name="ageRestriction" id="ageRestriction" class="form-control" 
                                       value="<%= service ? service.ageRestriction : '' %>" 
                                       min="0" max="99" placeholder="18">
                                <div class="invalid-feedback">
                                    Age must be between 0 and 99
                                </div>
                                <div class="field-hint">Leave empty if no age restriction</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label class="form-label">Booking Advance Notice (hours)</label>
                                <input type="number" name="bookingAdvanceNotice" id="bookingAdvanceNotice" class="form-control" 
                                       value="<%= service ? service.bookingAdvanceNotice : 24 %>" 
                                       min="0" placeholder="24">
                                <div class="field-hint">Minimum hours required before booking (default: 24)</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status & Features -->
                <div class="col-md-6">
                    <div class="form-card">
                        <h3><i class="fas fa-star me-2"></i>Status & Features</h3>
                        
                        <div class="form-check mb-3">
                            <input type="checkbox" name="isActive" class="form-check-input" id="isActive" 
                                   <%= service && service.isActive ? 'checked' : 'checked' %>>
                            <label class="form-check-label" for="isActive">
                                <strong>Active</strong> - Service is visible to clients
                            </label>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input type="checkbox" name="isFeatured" class="form-check-input" id="isFeatured" 
                                   <%= service && service.isFeatured ? 'checked' : '' %>>
                            <label class="form-check-label" for="isFeatured">
                                <strong>Featured</strong> - Show on homepage
                            </label>
                        </div>
                        
                        <div class="form-check mb-3">
                            <input type="checkbox" name="isPopular" class="form-check-input" id="isPopular" 
                                   <%= service && service.isPopular ? 'checked' : '' %>>
                            <label class="form-check-label" for="isPopular">
                                <strong>Popular</strong> - Mark as popular service
                            </label>
                        </div>
                        
                        <div class="form-check">
                            <input type="checkbox" name="requiresConsultation" class="form-check-input" id="requiresConsultation" 
                                   <%= service && service.requiresConsultation ? 'checked' : '' %>>
                            <label class="form-check-label" for="requiresConsultation">
                                <strong>Requires Consultation</strong>
                            </label>
                        </div>
                    </div>
                </div>

                <!-- Images -->
                <div class="col-12">
                    <div class="form-card">
                        <h3><i class="fas fa-images me-2"></i>Service Images</h3>
                        
                        <% if (service && service.images && service.images.length > 0) { %>
                        <div class="current-images mb-3">
                            <h6>Current Images:</h6>
                            <div class="image-grid">
                                <% service.images.forEach((image, index) => { %>
                                <div class="image-item">
                                    <img src="<%= image.url %>" alt="Service Image <%= index + 1 %>">
                                    <button type="button" class="btn-remove-image" onclick="removeImage('<%= image.public_id %>')">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                                <% }) %>
                            </div>
                        </div>
                        <% } %>
                        
                        <div class="upload-area" id="uploadArea">
                            <input type="file" name="images" id="serviceImages" multiple accept="image/*" class="file-input">
                            <label for="serviceImages" class="upload-label">
                                <i class="fas fa-cloud-upload-alt"></i>
                                <p><strong>Click to upload</strong> or drag and drop</p>
                                <p class="text-muted">PNG, JPG up to 5MB (Max 5 images)</p>
                            </label>
                        </div>
                        
                        <div id="imagePreview" class="image-preview mt-3"></div>
                    </div>
                </div>

                <!-- Submit Buttons -->
                <div class="col-12">
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save me-2"></i><%= service ? 'Update' : 'Create' %> Service
                        </button>
                        <a href="/admin/services" class="btn btn-outline-secondary btn-lg">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                    </div>
                </div>
            </div>
        </form>
    </div>
</div>

<style>
.admin-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 2rem;
}

.admin-container.with-nav {
    margin-left: 250px;
    margin-top: 0;
}

.admin-header {
    margin-bottom: 3rem;
}

.admin-header h1 {
    color: #2d3748;
    font-size: 2.5rem;
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
}

.form-container {
    background: #f7fafc;
    border-radius: 15px;
    padding: 2rem;
}

.form-card {
    background: white;
    border-radius: 15px;
    padding: 2rem;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    border: 1px solid rgba(0, 0, 0, 0.05);
    height: 100%;
}

.form-card h3 {
    color: #2d3748;
    margin-bottom: 1.5rem;
    padding-bottom: 1rem;
    border-bottom: 2px solid #e2e8f0;
    display: flex;
    align-items: center;
}

.form-label {
    font-weight: 600;
    color: #4a5568;
    margin-bottom: 0.5rem;
}

.form-control, .form-select {
    border: 1px solid #e2e8f0;
    border-radius: 8px;
    padding: 0.75rem;
}

.form-control:focus, .form-select:focus {
    border-color: #667eea;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
}

.form-check-input:checked {
    background-color: #667eea;
    border-color: #667eea;
}

.invalid-feedback {
    display: none;
    color: #dc2626;
    font-size: 0.875rem;
    margin-top: 0.25rem;
}

.form-control.is-invalid,
.form-select.is-invalid {
    border-color: #dc2626;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc2626'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc2626' stroke='none'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.form-control.is-invalid ~ .invalid-feedback,
.form-select.is-invalid ~ .invalid-feedback {
    display: block;
}

.form-control.is-valid,
.form-select.is-valid {
    border-color: #10b981;
    padding-right: calc(1.5em + 0.75rem);
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%2310b981' d='M2.3 6.73.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
    background-repeat: no-repeat;
    background-position: right calc(0.375em + 0.1875rem) center;
    background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
}

.field-hint {
    font-size: 0.8rem;
    color: #718096;
    margin-top: 0.25rem;
}

.char-counter {
    font-size: 0.8rem;
    color: #718096;
    text-align: right;
    margin-top: 0.25rem;
}

.char-counter.warning {
    color: #d69e2e;
}

.char-counter.danger {
    color: #dc2626;
}

.validation-summary {
    background: #fef2f2;
    border: 1px solid #fecaca;
    border-radius: 8px;
    padding: 1rem;
    margin-bottom: 1.5rem;
    display: none;
}

.validation-summary.show {
    display: block;
}

.validation-summary h5 {
    color: #dc2626;
    margin: 0 0 0.75rem 0;
    font-size: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.validation-summary ul {
    margin: 0;
    padding-left: 1.5rem;
}

.validation-summary li {
    color: #991b1b;
    margin-bottom: 0.5rem;
}

.upload-area {
    border: 2px dashed #cbd5e0;
    border-radius: 12px;
    padding: 2rem;
    text-align: center;
    transition: all 0.3s ease;
    cursor: pointer;
}

.upload-area:hover {
    border-color: #667eea;
    background: #f7fafc;
}

.upload-area.drag-over {
    border-color: #667eea;
    background: #eef2ff;
}

.file-input {
    display: none;
}

.upload-label {
    cursor: pointer;
    margin: 0;
}

.upload-label i {
    font-size: 3rem;
    color: #667eea;
    margin-bottom: 1rem;
    display: block;
}

.image-grid, .image-preview {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
    gap: 1rem;
}

.image-item {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    border: 2px solid #e2e8f0;
}

.image-item img {
    width: 100%;
    height: 150px;
    object-fit: cover;
    display: block;
}

.btn-remove-image {
    position: absolute;
    top: 0.5rem;
    right: 0.5rem;
    background: #ef4444;
    color: white;
    border: none;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.btn-remove-image:hover {
    background: #dc2626;
}

.form-actions {
    display: flex;
    gap: 1rem;
    justify-content: flex-end;
    padding-top: 2rem;
}

@media (max-width: 768px) {
    .admin-container {
        padding: 1rem;
    }
    
    .form-container {
        padding: 1rem;
    }
    
    .form-card {
        padding: 1.5rem;
    }
}
</style>

<script>
const serviceForm = document.getElementById('serviceForm');
const fileInput = document.getElementById('serviceImages');
const imagePreview = document.getElementById('imagePreview');
const uploadArea = document.getElementById('uploadArea');

// Form fields
const serviceName = document.getElementById('serviceName');
const serviceCategory = document.getElementById('serviceCategory');
const servicePrice = document.getElementById('servicePrice');
const shortDescription = document.getElementById('shortDescription');
const fullDescription = document.getElementById('fullDescription');
const serviceDuration = document.getElementById('serviceDuration');
const shortDescCounter = document.getElementById('shortDescCounter');
const fullDescCounter = document.getElementById('fullDescCounter');

// Initialize character counters
function updateCharCounters() {
    if (shortDescription) {
        const shortLength = shortDescription.value.length;
        shortDescCounter.textContent = shortLength;
        const shortCounter = shortDescCounter.parentElement;
        shortCounter.classList.remove('warning', 'danger');
        if (shortLength > 180) shortCounter.classList.add('danger');
        else if (shortLength > 160) shortCounter.classList.add('warning');
    }
    
    if (fullDescription) {
        const fullLength = fullDescription.value.length;
        fullDescCounter.textContent = fullLength;
        const fullCounter = fullDescCounter.parentElement;
        fullCounter.classList.remove('warning', 'danger');
        if (fullLength > 900) fullCounter.classList.add('danger');
        else if (fullLength > 800) fullCounter.classList.add('warning');
    }
}

// Real-time validation
function validateField(field) {
    const value = field.value.trim();
    let isValid = true;
    
    if (field.hasAttribute('required') && !value) {
        isValid = false;
    }
    
    if (field.type === 'number') {
        const numValue = parseFloat(value);
        const min = parseFloat(field.min);
        const max = parseFloat(field.max);
        
        if (isNaN(numValue)) {
            isValid = false;
        } else {
            if (!isNaN(min) && numValue < min) isValid = false;
            if (!isNaN(max) && numValue > max) isValid = false;
        }
    }
    
    if (field.hasAttribute('minlength')) {
        const minLength = parseInt(field.getAttribute('minlength'));
        if (value.length > 0 && value.length < minLength) {
            isValid = false;
        }
    }
    
    if (field.type === 'select-one' && field.hasAttribute('required')) {
        if (!value || value === '') {
            isValid = false;
        }
    }
    
    if (value.length > 0 || field.classList.contains('is-invalid') || field.classList.contains('is-valid')) {
        if (isValid) {
            field.classList.remove('is-invalid');
            field.classList.add('is-valid');
        } else {
            field.classList.remove('is-valid');
            field.classList.add('is-invalid');
        }
    }
    
    return isValid;
}

// Add event listeners for real-time validation
[serviceName, serviceCategory, servicePrice, shortDescription, fullDescription, serviceDuration].forEach(field => {
    if (field) {
        field.addEventListener('input', function() {
            validateField(this);
            updateCharCounters();
        });
        
        field.addEventListener('blur', function() {
            validateField(this);
        });
    }
});

// Initialize counters on page load
updateCharCounters();

// Comprehensive form validation
function validateForm() {
    const errors = [];
    const validationSummary = document.getElementById('validationSummary');
    const validationErrors = document.getElementById('validationErrors');
    
    // Clear previous validation
    validationErrors.innerHTML = '';
    validationSummary.classList.remove('show');
    
    // Service Name validation
    if (!serviceName.value.trim()) {
        errors.push('Service Name is required');
        serviceName.classList.add('is-invalid');
    } else if (serviceName.value.trim().length < 3) {
        errors.push('Service Name must be at least 3 characters');
        serviceName.classList.add('is-invalid');
    } else {
        serviceName.classList.remove('is-invalid');
        serviceName.classList.add('is-valid');
    }
    
    // Category validation
    if (!serviceCategory.value || serviceCategory.value === '') {
        errors.push('Please select a Category');
        serviceCategory.classList.add('is-invalid');
    } else {
        serviceCategory.classList.remove('is-invalid');
        serviceCategory.classList.add('is-valid');
    }
    
    // Price validation
    const price = parseFloat(servicePrice.value);
    if (!servicePrice.value || isNaN(price) || price <= 0) {
        errors.push('Price must be greater than $0');
        servicePrice.classList.add('is-invalid');
    } else {
        servicePrice.classList.remove('is-invalid');
        servicePrice.classList.add('is-valid');
    }
    
    // Short Description validation
    if (!shortDescription.value.trim()) {
        errors.push('Short Description is required');
        shortDescription.classList.add('is-invalid');
    } else if (shortDescription.value.trim().length < 10) {
        errors.push('Short Description must be at least 10 characters');
        shortDescription.classList.add('is-invalid');
    } else if (shortDescription.value.trim().length > 200) {
        errors.push('Short Description cannot exceed 200 characters');
        shortDescription.classList.add('is-invalid');
    } else {
        shortDescription.classList.remove('is-invalid');
        shortDescription.classList.add('is-valid');
    }
    
    // Full Description validation
    if (!fullDescription.value.trim()) {
        errors.push('Full Description is required');
        fullDescription.classList.add('is-invalid');
    } else if (fullDescription.value.trim().length < 10) {
        errors.push('Full Description must be at least 10 characters');
        fullDescription.classList.add('is-invalid');
    } else if (fullDescription.value.trim().length > 1000) {
        errors.push('Full Description cannot exceed 1000 characters');
        fullDescription.classList.add('is-invalid');
    } else {
        fullDescription.classList.remove('is-invalid');
        fullDescription.classList.add('is-valid');
    }
    
    // Duration validation
    const duration = parseInt(serviceDuration.value);
    if (!serviceDuration.value || isNaN(duration) || duration < 15) {
        errors.push('Duration must be at least 15 minutes');
        serviceDuration.classList.add('is-invalid');
    } else if (duration % 15 !== 0) {
        errors.push('Duration must be in 15-minute intervals (15, 30, 45, 60, etc.)');
        serviceDuration.classList.add('is-invalid');
    } else {
        serviceDuration.classList.remove('is-invalid');
        serviceDuration.classList.add('is-valid');
    }
    
    // Display errors if any
    if (errors.length > 0) {
        errors.forEach(error => {
            const li = document.createElement('li');
            li.textContent = error;
            validationErrors.appendChild(li);
        });
        validationSummary.classList.add('show');
        
        // Scroll to validation summary
        validationSummary.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        return false;
    }
    
    return true;
}

// File upload preview
fileInput.addEventListener('change', function(e) {
    handleFiles(e.target.files);
});

// Drag and drop
uploadArea.addEventListener('dragover', function(e) {
    e.preventDefault();
    uploadArea.classList.add('drag-over');
});

uploadArea.addEventListener('dragleave', function() {
    uploadArea.classList.remove('drag-over');
});

uploadArea.addEventListener('drop', function(e) {
    e.preventDefault();
    uploadArea.classList.remove('drag-over');
    fileInput.files = e.dataTransfer.files;
    handleFiles(e.dataTransfer.files);
});

function handleFiles(files) {
    imagePreview.innerHTML = '';
    
    if (files.length > 5) {
        showNotification('Maximum 5 images allowed', 'error');
        return;
    }
    
    for (let i = 0; i < Math.min(files.length, 5); i++) {
        const file = files[i];
        
        if (!file.type.startsWith('image/')) {
            showNotification('Only image files are allowed', 'error');
            continue;
        }
        
        if (file.size > 5 * 1024 * 1024) {
            showNotification('Image size must be less than 5MB', 'error');
            continue;
        }
        
        const reader = new FileReader();
        reader.onload = function(e) {
            const div = document.createElement('div');
            div.className = 'image-item';
            div.innerHTML = `
                <img src="${e.target.result}" alt="Preview">
                <button type="button" class="btn-remove-image" onclick="removePreview(this)">
                    <i class="fas fa-times"></i>
                </button>
            `;
            imagePreview.appendChild(div);
        };
        reader.readAsDataURL(file);
    }
}

function removePreview(button) {
    button.closest('.image-item').remove();
}

function removeImage(publicId) {
    if (confirm('Are you sure you want to remove this image?')) {
        // Implementation for removing existing images
        showNotification('Image removal will be implemented with backend', 'info');
    }
}

// Form submission
serviceForm.addEventListener('submit', async function(e) {
    e.preventDefault();
    
    // Validate form
    if (!validateForm()) {
        showNotification('Please fix all validation errors before submitting', 'error');
        return;
    }
    
    const formData = new FormData(serviceForm);
    const serviceId = '<%= service ? service._id : "" %>';
    const url = serviceId ? `/api/services/${serviceId}` : '/api/services';
    const method = serviceId ? 'PUT' : 'POST';
    
    // Show loading state
    const submitBtn = serviceForm.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
    
    try {
        const response = await fetch(url, {
            method: method,
            body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
            showNotification(data.message || 'Service saved successfully!', 'success');
            setTimeout(() => {
                window.location.href = '/admin/services';
            }, 1500);
        } else {
            // Handle backend validation errors
            if (data.errors && Array.isArray(data.errors)) {
                const validationSummary = document.getElementById('validationSummary');
                const validationErrors = document.getElementById('validationErrors');
                validationErrors.innerHTML = '';
                
                data.errors.forEach(error => {
                    const li = document.createElement('li');
                    li.textContent = error.msg || error.message || error;
                    validationErrors.appendChild(li);
                });
                
                validationSummary.classList.add('show');
                validationSummary.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
            
            showNotification(data.message || 'Failed to save service', 'error');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    } catch (error) {
        console.error('Error:', error);
        showNotification('Failed to save service. Please try again.', 'error');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalText;
    }
});

// Notification function
function showNotification(message, type = 'info') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
            <span>${message}</span>
        </div>
    `;
    
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white;
        padding: 1rem 1.5rem;
        border-radius: 10px;
        box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        z-index: 9999;
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(0)';
    }, 100);
    
    setTimeout(() => {
        notification.style.transform = 'translateX(100%)';
        setTimeout(() => {
            document.body.removeChild(notification);
        }, 300);
    }, 3000);
}
</script>

</body>
</html>

