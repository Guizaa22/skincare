<%- include('../partials/header', {title: 'Book Appointment', description: 'Book your skincare appointment online. Choose from our range of professional treatments and find a time that works for you.'}) %>

<!-- Page Header -->
<section class="page-header py-4 bg-light">
    <div class="container">
        <div class="row">
            <div class="col-12">
                <nav aria-label="breadcrumb">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item active">Book Appointment</li>
                    </ol>
                </nav>
                <h1 class="page-title h2 mb-0">Book Your Appointment</h1>
            </div>
        </div>
    </div>
</section>

<!-- Booking Form Section -->
<section class="booking-section py-5">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto">
                <!-- Progress Steps -->
                <div class="booking-progress mb-5">
                    <div class="progress-steps">
                        <div class="step active" data-step="1">
                            <div class="step-number">1</div>
                            <div class="step-label">Select Service</div>
                        </div>
                        <div class="step" data-step="2">
                            <div class="step-number">2</div>
                            <div class="step-label">Choose Date & Time</div>
                        </div>
                        <div class="step" data-step="3">
                            <div class="step-number">3</div>
                            <div class="step-label">Personal Information</div>
                        </div>
                        <div class="step" data-step="4">
                            <div class="step-number">4</div>
                            <div class="step-label">Confirmation</div>
                        </div>
                    </div>
                </div>

                <!-- Booking Form -->
                <form id="booking-form" class="booking-form">
                    <!-- Step 1: Service Selection -->
                    <div class="booking-step active" id="step-1">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title mb-0">Select a Service</h4>
                                <p class="text-muted mb-0">Choose the treatment you'd like to book</p>
                            </div>
                            <div class="card-body">
                                <div class="row g-3">
                                    <% if (services && services.length > 0) { %>
                                        <% services.forEach(service => { %>
                                            <div class="col-md-6">
                                                <div class="service-option" data-service-id="<%= service._id %>">
                                                    <input type="radio" 
                                                           id="service-<%= service._id %>" 
                                                           name="service" 
                                                           value="<%= service._id %>"
                                                           class="service-radio">
                                                    <label for="service-<%= service._id %>" class="service-label">
                                                        <div class="service-info">
                                                            <h6 class="service-name"><%= service.name %></h6>
                                                            <p class="service-description text-muted small mb-2">
                                                                <%= service.shortDescription %>
                                                            </p>
                                                            <div class="service-details">
                                                                <span class="service-duration">
                                                                    <i class="fas fa-clock me-1"></i><%= service.duration %> min
                                                                </span>
                                                                <span class="service-price text-primary fw-bold ms-3">
                                                                    $<%= service.price %>
                                                                </span>
                                                            </div>
                                                        </div>
                                                    </label>
                                                </div>
                                            </div>
                                        <% }) %>
                                    <% } else { %>
                                        <div class="col-12 text-center py-4">
                                            <p class="text-muted">No services available for booking at the moment.</p>
                                        </div>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                        
                        <div class="step-actions mt-4 text-end">
                            <button type="button" class="btn btn-primary" onclick="nextStep()" disabled id="step-1-next">
                                Next: Choose Date & Time <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: Date & Time Selection -->
                    <div class="booking-step" id="step-2">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title mb-0">Choose Date & Time</h4>
                                <p class="text-muted mb-0">Select your preferred appointment slot</p>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <label for="appointment-date" class="form-label">Select Date</label>
                                        <input type="date" 
                                               id="appointment-date" 
                                               name="appointmentDate" 
                                               class="form-control"
                                               min="<%= new Date().toISOString().split('T')[0] %>"
                                               required>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="appointment-time" class="form-label">Select Time</label>
                                        <select id="appointment-time" 
                                                name="appointmentTime" 
                                                class="form-select" 
                                                required>
                                            <option value="">Choose a time</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <!-- Available Slots Display -->
                                <div id="available-slots" class="mt-4" style="display: none;">
                                    <h6>Available Time Slots</h6>
                                    <div id="time-slots-container" class="time-slots-grid">
                                        <!-- Time slots will be populated dynamically -->
                                    </div>
                                </div>
                                
                                <!-- Loading indicator -->
                                <div id="slots-loading" class="text-center mt-4" style="display: none;">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="mt-2 text-muted">Loading available slots...</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="step-actions mt-4 d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-primary" onclick="prevStep()">
                                <i class="fas fa-arrow-left me-2"></i>Back
                            </button>
                            <button type="button" class="btn btn-primary" onclick="nextStep()" disabled id="step-2-next">
                                Next: Personal Info <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 3: Personal Information -->
                    <div class="booking-step" id="step-3">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title mb-0">Personal Information</h4>
                                <p class="text-muted mb-0">Tell us about your skin and any special requirements</p>
                            </div>
                            <div class="card-body">
                                <!-- Contact Information (Pre-filled from user account) -->
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <label for="firstName" class="form-label">First Name</label>
                                        <input type="text" 
                                               id="firstName" 
                                               name="firstName" 
                                               class="form-control" 
                                               value="<%= user.firstName %>" 
                                               readonly>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="lastName" class="form-label">Last Name</label>
                                        <input type="text" 
                                               id="lastName" 
                                               name="lastName" 
                                               class="form-control" 
                                               value="<%= user.lastName %>" 
                                               readonly>
                                    </div>
                                </div>
                                
                                <div class="row mb-4">
                                    <div class="col-md-6">
                                        <label for="email" class="form-label">Email</label>
                                        <input type="email" 
                                               id="email" 
                                               name="email" 
                                               class="form-control" 
                                               value="<%= user.email %>" 
                                               readonly>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="phone" class="form-label">Phone</label>
                                        <input type="tel" 
                                               id="phone" 
                                               name="phone" 
                                               class="form-control" 
                                               value="<%= user.phone %>" 
                                               readonly>
                                    </div>
                                </div>

                                <!-- Skin Assessment -->
                                <h6 class="mb-3">Skin Assessment</h6>
                                
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <label for="skinType" class="form-label">Skin Type</label>
                                        <select id="skinType" name="skinType" class="form-select">
                                            <option value="normal" <%= user.skinType === 'normal' ? 'selected' : '' %>>Normal</option>
                                            <option value="oily" <%= user.skinType === 'oily' ? 'selected' : '' %>>Oily</option>
                                            <option value="dry" <%= user.skinType === 'dry' ? 'selected' : '' %>>Dry</option>
                                            <option value="combination" <%= user.skinType === 'combination' ? 'selected' : '' %>>Combination</option>
                                            <option value="sensitive" <%= user.skinType === 'sensitive' ? 'selected' : '' %>>Sensitive</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label class="form-label">Primary Skin Concerns</label>
                                        <div class="d-flex flex-wrap gap-2">
                                            <% ['acne', 'aging', 'dryness', 'sensitivity', 'pigmentation', 'rosacea'].forEach(concern => { %>
                                                <div class="form-check">
                                                    <input class="form-check-input" 
                                                           type="checkbox" 
                                                           id="concern-<%= concern %>" 
                                                           name="skinConcerns" 
                                                           value="<%= concern %>"
                                                           <%= user.skinConcerns && user.skinConcerns.includes(concern) ? 'checked' : '' %>>
                                                    <label class="form-check-label" for="concern-<%= concern %>">
                                                        <%= concern.charAt(0).toUpperCase() + concern.slice(1) %>
                                                    </label>
                                                </div>
                                            <% }) %>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <label for="allergies" class="form-label">Known Allergies</label>
                                        <textarea id="allergies" 
                                                  name="allergies" 
                                                  class="form-control" 
                                                  rows="2" 
                                                  placeholder="Please list any known allergies or sensitivities..."><%= user.allergies ? user.allergies.join(', ') : '' %></textarea>
                                    </div>
                                </div>
                                
                                <div class="row mb-3">
                                    <div class="col-12">
                                        <label for="notes" class="form-label">Additional Notes</label>
                                        <textarea id="notes" 
                                                  name="notes" 
                                                  class="form-control" 
                                                  rows="3" 
                                                  placeholder="Any specific requests or information you'd like us to know..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="step-actions mt-4 d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-primary" onclick="prevStep()">
                                <i class="fas fa-arrow-left me-2"></i>Back
                            </button>
                            <button type="button" class="btn btn-primary" onclick="nextStep()">
                                Review Booking <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 4: Confirmation -->
                    <div class="booking-step" id="step-4">
                        <div class="card">
                            <div class="card-header">
                                <h4 class="card-title mb-0">Booking Confirmation</h4>
                                <p class="text-muted mb-0">Please review your appointment details</p>
                            </div>
                            <div class="card-body">
                                <div id="booking-summary">
                                    <!-- Booking summary will be populated dynamically -->
                                </div>
                                
                                <div class="booking-terms mt-4">
                                    <div class="form-check">
                                        <input class="form-check-input" 
                                               type="checkbox" 
                                               id="terms-agreement" 
                                               name="terms" 
                                               required>
                                        <label class="form-check-label" for="terms-agreement">
                                            I agree to the <a href="/terms" target="_blank">Terms of Service</a> 
                                            and <a href="/privacy" target="_blank">Privacy Policy</a>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="step-actions mt-4 d-flex justify-content-between">
                            <button type="button" class="btn btn-outline-primary" onclick="prevStep()">
                                <i class="fas fa-arrow-left me-2"></i>Back
                            </button>
                            <button type="submit" class="btn btn-success" id="confirm-booking">
                                <i class="fas fa-check me-2"></i>Confirm Booking
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</section>

<!-- Custom CSS for Booking Page -->
<style>
.booking-progress {
    margin-bottom: 2rem;
}

.progress-steps {
    display: flex;
    justify-content: space-between;
    margin-bottom: 2rem;
    position: relative;
}

.progress-steps::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 0;
    right: 0;
    height: 2px;
    background: #e9ecef;
    z-index: 1;
}

.step {
    text-align: center;
    position: relative;
    z-index: 2;
    flex: 1;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: #e9ecef;
    color: #6c757d;
    display: flex;
    align-items: center;
    justify-content: center;
    margin: 0 auto 0.5rem;
    font-weight: bold;
    transition: all 0.3s ease;
}

.step.active .step-number {
    background: var(--bs-primary);
    color: white;
}

.step.completed .step-number {
    background: var(--bs-success);
    color: white;
}

.step-label {
    font-size: 0.875rem;
    color: #6c757d;
}

.step.active .step-label {
    color: var(--bs-primary);
    font-weight: 600;
}

.booking-step {
    display: none;
}

.booking-step.active {
    display: block;
}

.service-option {
    position: relative;
}

.service-radio {
    position: absolute;
    opacity: 0;
}

.service-label {
    display: block;
    padding: 1rem;
    border: 2px solid #e9ecef;
    border-radius: 0.5rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.service-radio:checked + .service-label {
    border-color: var(--bs-primary);
    background: rgba(var(--bs-primary-rgb), 0.1);
}

.time-slots-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
    gap: 0.5rem;
}

.time-slot {
    padding: 0.5rem;
    border: 1px solid #dee2e6;
    border-radius: 0.25rem;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.time-slot:hover {
    background: rgba(var(--bs-primary-rgb), 0.1);
    border-color: var(--bs-primary);
}

.time-slot.selected {
    background: var(--bs-primary);
    color: white;
    border-color: var(--bs-primary);
}

.time-slot.disabled {
    background: #f8f9fa;
    color: #6c757d;
    cursor: not-allowed;
}
</style>

<!-- Page Script -->
<script src="/js/booking.js"></script>

<%- include('../partials/footer') %>
